# TMCP Server Production Docker Compose Configuration
#
# IMPORTANT: For production deployments, MAS (Matrix Authentication Service)
# should be deployed separately as a standalone service. See:
#   - docker-compose.dev.yml for local development with MAS
#   - https://element-hq.github.io/matrix-authentication-service/ for MAS deployment
#
# This configuration expects:
#   - External MAS instance running at MAS_URL (see environment variables below)
#   - External PostgreSQL database
#   - External Redis instance
#
# Configuration via environment variables (see README.md)

services:
  db:
    image: postgres:14
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-tmcp_production}
      POSTGRES_USER: ${POSTGRES_USER:-tmcp}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-tmcp_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-tmcp} -d ${POSTGRES_DB:-tmcp_production}"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  tmcp-server:
    build: .
    container_name: tmcp-server
    environment:
      RAILS_ENV: ${RAILS_ENV:-production}
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      SECRET_KEY_BASE: ${SECRET_KEY_BASE}
      BUNDLE_PATH: ${BUNDLE_PATH:-/usr/local/bundle}

      # TMCP Configuration
      TMCP_JWT_ISSUER: ${TMCP_JWT_ISSUER}
      TMCP_JWT_KEY_ID: ${TMCP_JWT_KEY_ID}

      # Matrix Integration
      MATRIX_API_URL: ${MATRIX_API_URL}
      MATRIX_HS_TOKEN: ${MATRIX_HS_TOKEN}

      # MAS Configuration (point to external MAS instance)
      MAS_URL: ${MAS_URL}
      MAS_CLIENT_ID: ${MAS_CLIENT_ID}
      MAS_CLIENT_SECRET: ${MAS_CLIENT_SECRET}
      MAS_TOKEN_URL: ${MAS_TOKEN_URL}
      MAS_INTROSPECTION_URL: ${MAS_INTROSPECTION_URL}
      MAS_REVOCATION_URL: ${MAS_REVOCATION_URL}

      # Security
      FORCE_SSL: ${FORCE_SSL:-true}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}

    volumes:
      - bundle:/usr/local/bundle
      - ./secrets/tmcp_private_key.txt:/run/secrets/tmcp_private_key:ro
    secrets:
      - tmcp_private_key
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "3000:3000"
    stdin_open: true
    tty: true

secrets:
  tmcp_private_key:
    file: ./secrets/tmcp_private_key.txt

volumes:
  postgres_data:
  redis_data:
  bundle:
